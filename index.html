<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAME44: HUB</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p-color: #8b5cf6; --s-color: #a78bfa; }
        body { background: #0f0716; color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(30, 15, 50, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.2); }
        .purple-glow { border: 1px solid var(--p-color); box-shadow: 0 0 25px rgba(139, 92, 246, 0.2); }
        .rocket-bg { background: radial-gradient(circle at top, #1e0f32 0%, #0f0716 100%); }
        .nav-active { color: #a78bfa; transform: translateY(-4px); text-shadow: 0 0 10px #8b5cf6; }
        @keyframes rocket-shake { 0%, 100% { transform: translate(0,0) rotate(0deg); } 25% { transform: translate(1px, -1px) rotate(0.5deg); } 50% { transform: translate(-1px, 1px) rotate(-0.5deg); } }
        .animate-rocket { animation: rocket-shake 0.1s infinite; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- Header -->
    <header class="p-4 glass sticky top-0 z-50 flex justify-between items-center border-b border-purple-500/20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-violet-600 border border-violet-400/30 overflow-hidden">
                <img src="" id="header-img" class="w-full h-full object-cover hidden">
                <div id="header-placeholder" class="w-full h-full flex items-center justify-center font-black">G</div>
            </div>
            <div>
                <h1 class="text-[10px] font-black uppercase tracking-widest text-violet-300">GAME44 <span class="text-white">HUB</span></h1>
                <p id="ui-faction" class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-violet-900/50 mt-1 uppercase border border-violet-500/30 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
        <div class="text-right">
            <p id="ui-balance" class="text-[11px] text-purple-400 font-black">0.00 TON</p>
            <p id="ui-skulls" class="text-[11px] text-rose-400 font-black">0 üíÄ</p>
        </div>
    </header>

    <!-- VIEWS -->
    <main id="view-tasks" class="app-view max-w-md mx-auto p-4 space-y-6">
        <div id="active-zone" class="hidden">
            <div class="glass p-6 rounded-3xl purple-glow space-y-4 bg-gradient-to-br from-violet-900/20 to-transparent">
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-black text-violet-400 uppercase flex items-center gap-2">
                        <span class="w-2 h-2 bg-violet-500 rounded-full animate-pulse"></span> –í –ø—Ä–æ—Ü–µ—Å—Å–µ
                    </span>
                    <span id="active-timer" class="font-mono text-xl font-black text-violet-100">00:00:00</span>
                </div>
                <h3 id="active-title" class="text-xl font-black uppercase italic"></h3>
                <p id="active-desc" class="text-xs text-slate-300 bg-black/20 p-3 rounded-xl border border-white/5"></p>
                <div class="flex justify-between items-center pt-4 border-t border-purple-500/10">
                    <span id="active-reward" class="text-violet-300 font-black text-lg"></span>
                    <button onclick="submitMission()" class="bg-violet-600 text-white text-[10px] font-black px-6 py-3 rounded-xl uppercase">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </div>
            </div>
        </div>
        <div class="space-y-4">
            <h2 class="text-[10px] font-black uppercase tracking-[0.3em] text-violet-400/70 italic">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
            <div id="tasks-container" class="space-y-3"></div>
        </div>
    </main>

    <main id="view-rocket" class="app-view max-w-md mx-auto p-4 hidden space-y-4">
        <div id="rocket-history" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar"></div>

        <div class="glass rounded-[2rem] p-6 rocket-bg border-violet-500/30 text-center space-y-6 relative overflow-hidden">
            <div class="h-40 flex items-end justify-center pb-4 relative">
                <img id="rocket-obj" src="" class="w-20 h-20 object-contain transition-all duration-300 ease-linear">
                <div id="rocket-multiplier" class="absolute top-0 text-5xl font-black italic tracking-tighter text-white">1.00x</div>
                <div id="rocket-status-text" class="absolute top-16 text-xs font-black uppercase tracking-[0.3em]"></div>
            </div>

            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="number" id="bet-amount" placeholder="–°—Ç–∞–≤–∫–∞ TON" class="flex-1 bg-black/40 border border-violet-500/30 rounded-xl p-4 text-center font-black outline-none text-white">
                    <button onclick="setBet(0.1)" class="bg-white/5 px-4 py-1 rounded text-[10px] font-bold">0.1</button>
                    <button onclick="setBet(0.5)" class="bg-white/5 px-4 py-1 rounded text-[10px] font-bold">0.5</button>
                </div>
                <button id="rocket-main-btn" onclick="handleRocketAction()" class="w-full bg-violet-600 p-5 rounded-2xl font-black uppercase tracking-widest shadow-xl transition-all">–í–∑–ª—ë—Ç</button>
                <p id="rocket-potential" class="text-[10px] font-black text-emerald-400 uppercase hidden">–ü—Ä–∏–±—ã–ª—å: +0.00 TON</p>
            </div>
        </div>

        <div class="space-y-3">
            <h3 class="text-[9px] font-black uppercase tracking-widest text-violet-400/60 ml-2">–°—Ç–∞–≤–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</h3>
            <div id="live-bets" class="space-y-2"></div>
        </div>
    </main>

    <main id="view-bank" class="app-view max-w-md mx-auto p-4 hidden space-y-6">
        <div class="glass rounded-3xl p-6 space-y-6">
            <h2 class="text-xl font-black uppercase italic">–ë–∞–Ω–∫</h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="topUp('TON')" class="bg-violet-600 p-4 rounded-2xl text-center"><p class="font-black text-white">TON</p></button>
                <button onclick="topUp('Stars')" class="bg-amber-500 p-4 rounded-2xl text-center text-black"><p class="font-black">STARS</p></button>
            </div>
            <div class="bg-black/40 p-6 rounded-2xl border border-white/5 space-y-4">
                <p class="text-xs font-black uppercase text-violet-400">–û–±–º–µ–Ω 1 TON = 100 üíÄ</p>
                <input type="number" id="swap-amount" placeholder="–ö–æ–ª-–≤–æ TON" class="w-full bg-white/5 p-4 rounded-xl outline-none font-black text-center text-white">
                <button onclick="swapToSkulls()" class="w-full bg-rose-600 p-4 rounded-xl font-black uppercase text-white shadow-lg">–û–±–º–µ–Ω—è—Ç—å –Ω–∞ –ß–µ—Ä–µ–ø–∞</button>
            </div>
        </div>
    </main>

    <main id="view-market" class="app-view max-w-md mx-auto p-4 hidden space-y-6">
        <h2 class="text-xl font-black uppercase italic px-2">–ú–∞—Ä–∫–µ—Ç</h2>
        <div id="market-items" class="grid grid-cols-2 gap-4"></div>
    </main>

    <main id="view-profile" class="app-view max-w-md mx-auto p-4 hidden space-y-6">
        <div class="glass rounded-[2rem] p-8 text-center space-y-4">
            <div class="w-20 h-20 mx-auto rounded-3xl bg-violet-600 border-2 border-violet-400/30 overflow-hidden shadow-2xl">
                <img src="" id="profile-img" class="w-full h-full object-cover hidden">
                <div id="profile-placeholder" class="w-full h-full flex items-center justify-center text-3xl font-black">?</div>
            </div>
            <h2 id="profile-tag" class="text-xl font-black text-white">@user</h2>
            <div class="grid grid-cols-2 gap-3 text-center">
                <div class="bg-white/5 p-3 rounded-2xl"><p class="text-[8px] uppercase font-bold text-violet-400">–ë–∞–ª–∞–Ω—Å</p><p id="profile-balance" class="font-black text-white">0</p></div>
                <div class="bg-white/5 p-3 rounded-2xl"><p class="text-[8px] uppercase font-bold text-rose-400">–ß–µ—Ä–µ–ø–∞</p><p id="profile-skulls" class="font-black text-white">0</p></div>
            </div>
            <div id="profile-edit" class="space-y-3 pt-4">
                <input type="text" id="edit-avatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏" class="w-full bg-white/5 p-3 rounded-xl text-xs outline-none text-white">
                <textarea id="edit-bio" placeholder="–û —Å–µ–±–µ..." class="w-full bg-white/5 p-3 rounded-xl text-xs h-20 outline-none text-white"></textarea>
                <button onclick="saveProfile()" class="w-full bg-violet-600 p-3 rounded-xl text-[10px] font-black uppercase">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-purple-500/20 px-2 py-4 flex justify-between items-center z-50">
        <button onclick="switchTab('tasks')" class="nav-btn flex-1 text-violet-400/50" id="nav-tasks"><i class="fas fa-list-check text-lg"></i></button>
        <button onclick="switchTab('rocket')" class="nav-btn flex-1 text-violet-400/50" id="nav-rocket"><i class="fas fa-rocket text-lg"></i></button>
        <button onclick="switchTab('bank')" class="nav-btn flex-1 text-violet-400/50" id="nav-bank"><i class="fas fa-university text-lg"></i></button>
        <button onclick="switchTab('market')" class="nav-btn flex-1 text-violet-400/50" id="nav-market"><i class="fas fa-gift text-lg"></i></button>
        <button onclick="switchTab('profile')" class="nav-btn flex-1 text-violet-400/50" id="nav-profile"><i class="fas fa-user text-lg"></i></button>
    </nav>

    <div id="reg-modal" class="fixed inset-0 bg-[#0f0716] z-[100] flex items-center justify-center p-6 hidden">
        <div class="w-full max-w-xs space-y-6 text-center">
            <h2 class="text-2xl font-black italic text-violet-100 uppercase">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="grid grid-cols-1 gap-4">
                <button onclick="completeRegistration('44')" class="p-6 rounded-3xl border-2 border-violet-500/30 bg-violet-900/10"><div class="text-xl font-black text-white">–ò–ì–†–û–ö 44</div><div class="text-[8px] uppercase tracking-widest text-violet-400">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç</div></button>
                <button onclick="completeRegistration('93')" class="p-6 rounded-3xl border-2 border-emerald-500/30 bg-emerald-900/10"><div class="text-xl font-black text-white">–ò–ì–†–û–ö 93</div><div class="text-[8px] uppercase tracking-widest text-emerald-400">–†–µ–∞–ª—å–Ω–∞—è –∂–∏–∑–Ω—å</div></button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xzzaoniuzvcxqfugvfzh.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_YAn708jttD0b0vAGLPreog_ZnCvFhAH';
        const TG_BOT_TOKEN = '8321050426:AAH4fKadiex7i9NQnC7T2ZyjscRknQgFKlI';
        const TG_CHAT_ID = '-1003693227904';
        
        // –í–°–¢–ê–í–¨ –°–°–´–õ–ö–£ –ù–ê –°–í–û–Æ –ì–ò–§–ö–£ –°–Æ–î–ê:
        const ROCKET_GIF_URL = 'https://i.ibb.co/ZRbWrDBg/93.gif'; 

        const tg = window.Telegram.WebApp;
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let player = null;
        let gameState = { status: 'waiting', multiplier: 1.0, startTime: 0 };
        let myBet = null;
        let flightAnimation = null;

        const gifts = [
            { id: 1, name: 'TG Premium (1 –º–µ—Å)', price: 450, icon: 'üíé' },
            { id: 2, name: 'TG Premium (1 –≥–æ–¥)', price: 3500, icon: 'üëë' },
            { id: 3, name: '1000 Stars', price: 1200, icon: '‚≠ê' }
        ];

        window.onload = async () => {
            const user = tg.initDataUnsafe?.user || { id: 'test_id', username: 'guest' };
            const tag = `@${user.username || user.id}`;
            const { data } = await sb.from('users').select('*').eq('id', tag).maybeSingle();
            if (data) { player = data; initApp(); } 
            else { document.getElementById('reg-modal').classList.remove('hidden'); }
            renderMarket();
            initRocketRealtime();
        };

        async function completeRegistration(faction) {
            const user = tg.initDataUnsafe?.user || { id: 'test_id', username: 'guest' };
            const tag = `@${user.username || user.id}`;
            const { error } = await sb.from('users').insert({ id: tag, tg_id: user.id.toString(), faction, balance: 0, skulls: 0 });
            if(!error) location.reload();
        }

        function initApp() {
            document.getElementById('reg-modal').classList.add('hidden');
            document.getElementById('ui-faction').innerText = `–ò–ì–†–û–ö ${player.faction}`;
            document.getElementById('profile-tag').innerText = player.id;
            updateUI();
            switchTab('tasks');
            loadTasks();
            setInterval(syncPlayerData, 5000);
        }

        function updateUI() {
            document.getElementById('rocket-obj').src = ROCKET_GIF_URL;
            if(player.avatar_url) {
                document.getElementById('header-img').src = player.avatar_url; document.getElementById('header-img').classList.remove('hidden');
                document.getElementById('header-placeholder').classList.add('hidden');
                document.getElementById('profile-img').src = player.avatar_url; document.getElementById('profile-img').classList.remove('hidden');
                document.getElementById('profile-placeholder').classList.add('hidden');
            }
            document.getElementById('ui-balance').innerText = `${parseFloat(player.balance || 0).toFixed(2)} TON`;
            document.getElementById('ui-skulls').innerText = `${player.skulls || 0} üíÄ`;
            document.getElementById('profile-balance').innerText = parseFloat(player.balance || 0).toFixed(2);
            document.getElementById('profile-skulls').innerText = player.skulls || 0;
        }

        async function syncPlayerData() {
            const { data } = await sb.from('users').select('*').eq('id', player.id).single();
            if(data) { player = data; updateUI(); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.app-view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('nav-active');
        }

        function initRocketRealtime() {
            sb.channel('rocket_session')
                .on('postgres_changes', { event: 'UPDATE', table: 'rocket_state', schema: 'public' }, payload => {
                    gameState = payload.new;
                    updateRocketUI();
                }).subscribe();

            sb.channel('rocket_bets')
                .on('postgres_changes', { event: '*', table: 'rocket_bets', schema: 'public' }, () => {
                    loadRocketBets();
                }).subscribe();

            loadRocketState();
            loadRocketBets();
        }

        async function loadRocketState() {
            const { data } = await sb.from('rocket_state').select('*').eq('id', 1).single();
            if(data) { gameState = data; updateRocketUI(); }
        }

        async function loadRocketBets() {
            const { data } = await sb.from('rocket_bets').select('*').order('amount', { ascending: false });
            const container = document.getElementById('live-bets');
            if(!container) return;
            container.innerHTML = '';
            myBet = data.find(b => b.player_id === player.id);
            data.forEach(b => {
                const div = document.createElement('div');
                div.className = `glass p-3 rounded-xl flex justify-between items-center text-[10px] ${b.status === 'cashed_out' ? 'border-emerald-500/30' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="font-black ${b.status === 'cashed_out' ? 'text-emerald-400' : 'text-white'}">${b.player_id}</span>
                        <span class="text-violet-400">${b.amount} TON</span>
                    </div>
                    <div>${b.status === 'cashed_out' ? `<span class="font-black text-emerald-400">${b.cashout_at}x</span>` : b.status === 'lost' ? '<span class="text-rose-500 font-bold">Crash</span>' : '<span class="animate-pulse text-violet-300">–õ–µ—Ç–∏—Ç...</span>'}</div>`;
                container.appendChild(div);
            });
        }

        function updateRocketUI() {
            const btn = document.getElementById('rocket-main-btn');
            const multEl = document.getElementById('rocket-multiplier');
            const statusEl = document.getElementById('rocket-status-text');
            const rocketObj = document.getElementById('rocket-obj');
            const potEl = document.getElementById('rocket-potential');
            
            cancelAnimationFrame(flightAnimation);

            const histCont = document.getElementById('rocket-history');
            histCont.innerHTML = '';
            (gameState.history || []).slice(-10).reverse().forEach(h => {
                const span = document.createElement('span');
                span.className = `px-3 py-1 rounded-full text-[9px] font-black border ${h >= 2 ? 'border-emerald-500 text-emerald-400' : 'border-rose-500 text-rose-400'}`;
                span.innerText = parseFloat(h).toFixed(2) + 'x';
                histCont.appendChild(span);
            });

            if(gameState.status === 'waiting') {
                statusEl.innerText = '–û–ñ–ò–î–ê–ù–ò–ï –°–¢–ê–í–û–ö...';
                statusEl.className = 'absolute top-16 text-xs font-black uppercase text-violet-400 tracking-widest';
                rocketObj.classList.remove('animate-rocket');
                rocketObj.style.transform = 'translateY(0) scale(1)';
                potEl.classList.add('hidden');
                
                const updateWaiting = () => {
                    const diff = Math.max(0, 15000 - (Date.now() - gameState.start_time));
                    multEl.innerText = (diff / 1000).toFixed(1) + 's';
                    if(gameState.status === 'waiting') requestAnimationFrame(updateWaiting);
                };
                updateWaiting();

                if(myBet) {
                    btn.innerText = '–°–¢–ê–í–ö–ê –ü–†–ò–ù–Ø–¢–ê'; btn.disabled = true; btn.className = 'w-full bg-white/10 p-5 rounded-2xl font-black uppercase tracking-widest opacity-50';
                } else {
                    btn.innerText = '–í–ó–õ–Å–¢'; btn.disabled = false; btn.className = 'w-full bg-violet-600 p-5 rounded-2xl font-black uppercase tracking-widest';
                }
            } 
            else if(gameState.status === 'flying') {
                statusEl.innerText = '–ü–û–õ–ï–¢...';
                statusEl.className = 'absolute top-16 text-xs font-black uppercase text-emerald-400 tracking-widest';
                rocketObj.classList.add('animate-rocket');

                const updateFlight = () => {
                    const elapsed = Math.max(0, (Date.now() - gameState.start_time - 150)) / 1000;
                    const curMult = Math.pow(1.15, elapsed);
                    multEl.innerText = curMult.toFixed(2) + 'x';
                    rocketObj.style.transform = `translateY(-${Math.min((curMult-1)*20, 140)}px)`;
                    
                    if(myBet && myBet.status === 'active') {
                        btn.innerText = '–ó–ê–ë–†–ê–¢–¨'; btn.disabled = false; btn.className = 'w-full bg-emerald-600 p-5 rounded-2xl font-black uppercase tracking-widest';
                        potEl.classList.remove('hidden');
                        potEl.innerText = `–ü—Ä–∏–±—ã–ª—å: +${(myBet.amount * curMult).toFixed(2)} TON`;
                    }
                    if(gameState.status === 'flying') flightAnimation = requestAnimationFrame(updateFlight);
                };
                updateFlight();

                if(myBet && myBet.status === 'cashed_out') {
                    btn.innerText = `–í–ó–Ø–¢–û ${myBet.cashout_at}x`; btn.disabled = true;
                    btn.className = 'w-full bg-white/10 p-5 rounded-2xl font-black uppercase tracking-widest opacity-50';
                } else if(!myBet) {
                    btn.innerText = '–ñ–î–ò–¢–ï –†–ê–£–ù–î'; btn.disabled = true;
                    btn.className = 'w-full bg-white/10 p-5 rounded-2xl font-black uppercase tracking-widest opacity-50';
                }
            } 
            else if(gameState.status === 'crashed') {
                multEl.innerText = parseFloat(gameState.multiplier).toFixed(2) + 'x';
                statusEl.innerText = 'CRASH!';
                statusEl.className = 'absolute top-16 text-xs font-black uppercase text-rose-500 tracking-widest';
                rocketObj.classList.remove('animate-rocket');
                rocketObj.style.transform = 'scale(0)';
                btn.innerText = '–†–ê–£–ù–î –û–ö–û–ù–ß–ï–ù'; btn.disabled = true;
                btn.className = 'w-full bg-white/10 p-5 rounded-2xl font-black uppercase tracking-widest opacity-50';
                potEl.classList.add('hidden');
            }
        }

        async function handleRocketAction() {
            if(gameState.status === 'waiting') {
                const amount = parseFloat(document.getElementById('bet-amount').value);
                if(isNaN(amount) || amount <= 0 || amount > player.balance) return;
                await sb.from('users').update({ balance: player.balance - amount }).eq('id', player.id);
                await sb.from('rocket_bets').insert({ player_id: player.id, amount, round_id: gameState.start_time });
                syncPlayerData();
            } 
            else if(gameState.status === 'flying' && myBet && myBet.status === 'active') {
                const elapsed = Math.max(0, (Date.now() - gameState.start_time - 150)) / 1000;
                const m = Math.pow(1.15, elapsed);
                const win = myBet.amount * m;
                
                const { data } = await sb.from('rocket_bets')
                    .update({ status: 'cashed_out', cashout_at: parseFloat(m.toFixed(2)) })
                    .eq('id', myBet.id)
                    .eq('status', 'active')
                    .select();

                if(data && data.length > 0) {
                    await sb.from('users').update({ balance: player.balance + win }).eq('id', player.id);
                    if(m >= 2.0) sendTelegram(`üöÄ **WIN**\nüë§ ${player.id}\nüìà ${m.toFixed(2)}x\nüí∞ +${win.toFixed(2)} TON`);
                    syncPlayerData();
                } else {
                    alert("–†–∞–∫–µ—Ç–∞ —É–∂–µ –≤–∑–æ—Ä–≤–∞–ª–∞—Å—å!");
                    loadRocketBets();
                }
            }
        }

        async function loadTasks() {
            const { data } = await sb.from('tasks').select('*');
            const done = JSON.parse(localStorage.getItem(`done_${player.id}`) || '[]');
            const active = JSON.parse(localStorage.getItem(`active_${player.id}`));
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            data.filter(t => (t.faction === player.faction || t.target === player.id) && !done.includes(t.id) && (!active || active.id !== t.id))
            .forEach(t => {
                const div = document.createElement('div');
                div.className = 'glass p-5 rounded-2xl flex justify-between items-center';
                div.innerHTML = `<div><h4 class="text-xs font-black uppercase text-white">${t.title}</h4><p class="text-[10px] text-violet-400 font-bold">${t.reward} TON</p></div>
                <button onclick="acceptTask('${t.id}')" class="bg-violet-600/20 border border-violet-500/30 text-[9px] font-black px-4 py-2 rounded-lg uppercase">–ü—Ä–∏–Ω—è—Ç—å</button>`;
                container.appendChild(div);
            });
            if(active) showActive(active);
        }

        async function acceptTask(id) {
            const { data } = await sb.from('tasks').select('*').eq('id', id).single();
            const dur = (data.duration_hours || 2) * 3600000;
            const activeData = { ...data, expires: Date.now() + dur };
            localStorage.setItem(`active_${player.id}`, JSON.stringify(activeData));
            showActive(activeData);
            sendTelegram(`üü£ **–ü–†–ò–ù–Ø–¢–û**\nüë§ ${player.id}\nüéØ ${data.title}`);
            loadTasks();
        }

        function showActive(data) {
            document.getElementById('active-zone').classList.remove('hidden');
            document.getElementById('active-title').innerText = data.title;
            document.getElementById('active-desc').innerText = data.description || '–í—ã–ø–æ–ª–Ω–∏ —É—Å–ª–æ–≤–∏—è.';
            document.getElementById('active-reward').innerText = `${data.reward} TON`;
            startTimer(data.expires);
        }

        function startTimer(exp) {
            const tick = () => {
                const diff = exp - Date.now();
                if(diff <= 0) { localStorage.removeItem(`active_${player.id}`); location.reload(); }
                const h = Math.floor(diff/3600000).toString().padStart(2,'0'), m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0'), s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                if(document.getElementById('active-timer')) document.getElementById('active-timer').innerText = `${h}:${m}:${s}`;
            };
            tick(); setInterval(tick, 1000);
        }

        async function submitMission() {
            const m = JSON.parse(localStorage.getItem(`active_${player.id}`));
            await sb.from('reports').insert({ player_tag: player.id, task_title: m.title, reward: m.reward });
            let done = JSON.parse(localStorage.getItem(`done_${player.id}`) || '[]');
            done.push(m.id); localStorage.setItem(`done_${player.id}`, JSON.stringify(done));
            localStorage.removeItem(`active_${player.id}`);
            document.getElementById('active-zone').classList.add('hidden');
            sendTelegram(`‚è≥ **–û–¢–ß–ï–¢**\nüë§ ${player.id}\nüìã ${m.title}`);
            loadTasks();
        }

        function renderMarket() {
            const cont = document.getElementById('market-items'); cont.innerHTML = '';
            gifts.forEach(g => {
                const div = document.createElement('div');
                div.className = 'glass p-4 rounded-3xl text-center space-y-2';
                div.innerHTML = `<div class="text-3xl">${g.icon}</div><div class="text-[9px] font-black uppercase h-8">${g.name}</div>
                <button onclick="buyGift('${g.name}', ${g.price})" class="w-full bg-rose-600/20 border border-rose-500/30 text-rose-300 text-[9px] font-black py-2 rounded-xl">${g.price} üíÄ</button>`;
                cont.appendChild(div);
            });
        }

        async function buyGift(name, price) {
            if(player.skulls < price) return alert('–ú–∞–ª–æ üíÄ');
            if(confirm(`–ö—É–ø–∏—Ç—å ${name}?`)) {
                await sb.from('users').update({ skulls: player.skulls - price }).eq('id', player.id);
                await sb.from('gift_orders').insert({ player_tag: player.id, gift_name: name, price_skulls: price });
                sendTelegram(`üõí **–ú–ê–†–ö–ï–¢**\nüë§ ${player.id}\nüéÅ ${name}`);
                syncPlayerData();
            }
        }

        async function saveProfile() {
            const updates = { avatar_url: document.getElementById('edit-avatar').value, bio: document.getElementById('edit-bio').value };
            await sb.from('users').update(updates).eq('id', player.id);
            syncPlayerData();
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        }

        async function topUp(type) {
            const amount = type === 'TON' ? 1.0 : 100;
            if(type === 'TON') player.balance = parseFloat(player.balance) + amount;
            await sb.from('users').update({ balance: player.balance }).eq('id', player.id);
            syncPlayerData();
        }

        async function swapToSkulls() {
            const ton = parseFloat(document.getElementById('swap-amount').value);
            if(isNaN(ton) || ton <= 0 || ton > player.balance) return;
            await sb.from('users').update({ balance: player.balance - ton, skulls: (player.skulls || 0) + (ton * 100) }).eq('id', player.id);
            document.getElementById('swap-amount').value = '';
            syncPlayerData();
        }

        async function sendTelegram(text) {
            if(TG_BOT_TOKEN === '–¢–í–û–ô_–¢–û–ö–ï–ù') return;
            try { await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: TG_CHAT_ID, text, parse_mode: 'Markdown' }) }); } catch(e) {}
        }
        function setBet(v) { document.getElementById('bet-amount').value = v; }
    </script>
</body>
</html>